<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Inc. - Ante 1</title>
    <style>
        :root {
            --bg-deep: #0f172a; --bg-slate: #1e293b;
            --accent-blue: #38bdf8; --accent-green: #22c55e;
            --text-gold: #f1c40f; --card-white: #f8fafc;
            --rent-red: #ef4444; --joker-purple: #a855f7;
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif;
            background: radial-gradient(circle at top, var(--bg-slate), var(--bg-deep));
            color: white; margin: 0; padding: 20px 0;
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh; touch-action: pan-y;
        }

        .header { width: 100%; max-width: 400px; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
        .stats-badge { background: rgba(255,255,255,0.1); padding: 8px 16px; border-radius: 20px; color: var(--text-gold); font-weight: bold; }

        /* TICKET SELECTOR */
        .ticket-menu { display: flex; gap: 8px; margin: 15px 0; width: 320px; }
        .ticket-tab { flex: 1; padding: 10px; border-radius: 12px; background: #334155; cursor: pointer; text-align: center; font-size: 0.7rem; font-weight: bold; }
        .ticket-tab.active { border-color: var(--accent-blue); background: #1e293b; color: var(--accent-blue); border: 2px solid; }

        .card-container { position: relative; width: 320px; height: 320px; background: var(--card-white); border-radius: 24px; overflow: hidden; border: 6px solid #334155; }
        .prize-grid { display: grid; width: 100%; height: 100%; position: absolute; }
        .prize-cell { display: flex; align-items: center; justify-content: center; font-size: 2.5rem; border: 1px solid #e2e8f0; color: #334155; }
        canvas { position: absolute; top: 0; left: 0; z-index: 10; touch-action: none; }

        .day-tracker { width: 320px; margin: 10px 0; display: flex; justify-content: space-between; font-size: 0.8rem; color: #94a3b8; font-weight: bold; }

        .btn-primary { background: var(--accent-green); color: white; border: none; padding: 16px; width: 320px; border-radius: 16px; cursor: pointer; font-weight: bold; font-size: 1.1rem; box-shadow: 0 4px 0 #15803d; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        #auto-reveal-btn:disabled {
        cursor: not-allowed;
        opacity: 0.5;
        filter: grayscale(1);
        }

        /* New Reset Button Style */
        .btn-reset { 
            background: transparent; color: #94a3b8; border: 1px solid #334155; 
            padding: 8px 16px; border-radius: 12px; cursor: pointer; font-size: 0.7rem; 
            margin-top: 10px; transition: all 0.2s;
        }
        .btn-reset:hover { border-color: var(--rent-red); color: var(--rent-red); }

        /* Ensure the token bar has visibility */
        .token-bar { 
            display: flex; gap: 8px; justify-content: center; 
            margin: 15px 0; min-height: 45px; 
        }
        .token-slot {
             width: 40px; height: 40px;
            background: var(--bg-slate);
            border: 2px solid #334155;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: help;
            position: relative; transition: all 0.2s;
        }

        /* Hover Tooltip */
        .token-slot:hover::after {
            content: attr(data-tip);
            position: absolute; bottom: 50px; left: 50%;
            transform: translateX(-50%);
            background: #1e293b; border: 1px solid var(--accent-blue);
            padding: 8px; border-radius: 6px; font-size: 0.75rem;
            width: 140px; z-index: 100; color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            line-height: 1.2; pointer-events: none;
        }

        /* SHOP LAYOUT CATEGORIES */
        /* Item cards for shop */
        .item-card { background: #1e293b; padding: 10px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #334155; }
        .item-info { text-align: left; }
        .item-info b { display: block; color: var(--accent-blue); font-size: 0.9rem; }
        .item-info span { font-size: 0.65rem; color: #94a3b8; }
        .btn-buy-item { background: var(--text-gold); border: none; padding: 8px; border-radius: 8px; font-weight: bold; cursor: pointer; min-width: 60px; }

        .multiplier-tag { font-size: 0.6rem; background: var(--joker-purple); color: white; padding: 2px 6px; border-radius: 4px; margin-top: 5px; display: inline-block; }

        .shop-section { margin-bottom: 20px; text-align: left; }
        .shop-section-title { 
        font-size: 0.8rem; color: var(--accent-blue); 
        border-bottom: 1px solid #334155; margin-bottom: 10px; 
        padding-bottom: 4px; letter-spacing: 1px;
        }
        .shop-grid { display: grid; grid-template-columns: 1fr; gap: 8px; }

        /* Sold Out State */
        .item-card.sold-out { opacity: 0.4; pointer-events: none; filter: grayscale(1); }

        /* MODALS */
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; color: #0f172a; padding: 25px; border-radius: 24px; z-index: 100; text-align: center; width: 280px; box-shadow: 0 0 100px rgba(0,0,0,0.8); }
        .shop-modal { background: var(--bg-deep); color: white; width: 320px; border: 2px solid var(--accent-blue); }
    </style>
</head>
<body>

    <div class="header">
        <div><b>ANTE <span id="ante-num">1</span></b></div>
        <div class="stats-badge">üí∞ <span id="coin-count">--</span></div>
        <button class="btn-reset" onclick="resetRun()">RESET RUN</button>
    </div>

    <div id="symbol-levels" style="display: flex; gap: 10px; justify-content: center; margin-bottom: 5px; font-size: 0.7rem; color: #94a3b8;"></div>
    <div class="token-bar" id="token-bar"></div>

    <div class="ticket-menu" id="ticket-menu">
        <div class="ticket-tab active" onclick="selectTicket('mini', this)">MINI (2)</div>
        <div class="ticket-tab" onclick="selectTicket('mega', this)">MEGA (10)</div>
        <div class="ticket-tab" onclick="selectTicket('ultra', this)">ULTRA (50)</div>
    </div>

    <div class="card-container">
        <div class="prize-grid" id="prize-grid"></div>
        <canvas id="scratch-canvas" width="320" height="320"></canvas>
        <canvas id="particle-canvas" width="320" height="320" style="pointer-events:none; z-index:20; position:absolute;"></canvas>
    </div>

    <div class="day-tracker">
        <span>Day <span id="day-num">1</span>/10</span>
        <span>Cards: <span id="cards-count">0</span>/5</span>
        <span style="color:var(--rent-red)">Rent: <span id="rent-amount">5</span></span>
    </div>

    <button id="buy-btn" class="btn-primary" onclick="buyCard()">BUY CARD</button>
    <button id="auto-reveal-btn" class="btn-primary" 
        style="display:none; background:var(--accent-blue); margin-top:10px;" 
        onclick="autoReveal()">QUICK REVEAL</button>

    <div id="shop-modal" class="modal shop-modal">
        <h3 style="color:var(--accent-blue); margin:0 0 10px 0;">NIGHT SHOP</h3>
        <p id="shop-rent-msg" style="font-size:0.8rem; margin-bottom:15px;"></p>
        <div id="shop-items" style="max-height: 300px; overflow-y: auto;"></div>
        <button id="reroll-btn" class="buy-btn" style="flex:1;" onclick="rerollShop()">
        Reroll (<span id="reroll-display">5</span>üí∞)
        </button>
        <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="nextDay()">START NEXT DAY</button>
    </div>

    <div id="result-modal" class="modal">
        <h2 id="modal-title"></h2>
        <p id="modal-msg"></p>
        <button class="btn-primary" style="width: 100%;" onclick="closeModal()">COLLECT</button>
    </div>

    <div id="boss-modal" class="modal">
    <div class="modal-content" style="border: 2px solid var(--joker-purple); text-align: center;">
        <h2 id="boss-title" style="color: var(--joker-purple); font-size: 2rem;">‚Äî THE TAX MAN ‚Äî</h2>
        <div id="boss-icon" style="font-size: 4rem; margin: 10px 0;">üïµÔ∏è‚Äç‚ôÇÔ∏è</div>
        <h3 id="mod-name" style="margin-bottom: 5px;"></h3>
        <p id="mod-desc" style="opacity: 0.8; margin-bottom: 20px;"></p>
        <button class="buy-btn" onclick="closeBossModal()" style="width: 100%;">I'll pay...</button>
    </div>
</div>

<script>
    // New Global to track if AutoReveal is bought
    window.hasAutoReveal = false;

    let rerollCost = 5;

    let currentSymbols = []; // Stores the symbols of the currently active card
    let currentType = 'mini'; // Tracks which ticket type is active (mini, mega, ultra)
    let winningIndices = []; 
    let winColor = "var(--accent-green)";
    let isJackpot = false;
    let pendingWin = 0;

    const TOKENS_DB = [
    { id: 't1', name: 'Golden Coin', icon: 'ü™ô', desc: '+5üí∞ flat win on every card', cost: 40 },
    { id: 't2', name: 'Lucky Dice', icon: 'üé≤', desc: '1 in 4 chance to double your win', cost: 50 },
    { id: 't3', name: 'Sharp Nail', icon: 'üíÖ', desc: 'Instantly reveal 10% more card', cost: 35 },
    { id: 't4', name: 'Tax Loophole', icon: 'üìú', desc: '-10üí∞ from end-of-day Rent', cost: 60 },
    { id: 't5', name: 'Lemon Squeezer', icon: 'üçã', desc: 'üçã matches pay 3x', cost: 45 }
    ];

    const BOSS_MODS = [
    { id: 'frozen_slot', name: "Audit", desc: "One random token slot is disabled today.", icon: "‚ùÑÔ∏è" },
    { id: 'double_cost', name: "Inflation", desc: "All scratch cards cost 2x more today.", icon: "üìà" },
    { id: 'no_pairs', name: "Standardization", desc: "Pairs pay $0 today. Only 3-of-a-kind or better counts!", icon: "üö´" },
    { id: 'tax_cut', name: "Hidden Fees", desc: "Every card played costs an extra $5 flat.", icon: "üí∏" }
    ];

    let activeBossMod = null; // Global variable to track the current boss effect
    let frozenSlotIndex = null; // Stores index 0-4

    let tokens = []; // The player's current 5 slots

    const TICKET_TYPES = {
        mini:  { cost: 2,  cols: 2, rows: 2, win3: 10, win2: 5,  pair2: 15 },
        mega:  { cost: 10, cols: 3, rows: 3, win3: 100, win2: 20, pair2: 50 },
        ultra: { cost: 50, cols: 4, rows: 4, win3: 500, win2: 100, pair2: 250 }
    };

    let coins = 20, sizeLvl = 1, strLvl = 1, day = 1, cardsPlayed = 0, ante = 1;
    let multipliers = { 'üçí': 1, 'üíé': 1, 'üçã': 1, '‚≠ê': 1, 'üîî': 1 };
    let cardActive = false, isDrawing = false, lastX, lastY;
    let boughtItemsThisNight = new Set(); // Tracks what was bought tonight
    const symbols = ['üçí', 'üíé', 'üçã', '‚≠ê', 'üîî'];
    
    // Default base values for symbols
    let symbolData = {
    'üçí': { val: 5,  lvl: 1 },
    'üçã': { val: 10, lvl: 1 },
    'üîî': { val: 15, lvl: 1 },
    '‚≠ê': { val: 20, lvl: 1 },
    'üíé': { val: 30, lvl: 1 }
    };

    const canvas = document.getElementById('scratch-canvas');
    const ctx = canvas.getContext('2d');
    const pCtx = document.getElementById('particle-canvas').getContext('2d');
    let particles = [];

    // New Global to track if AutoReveal is bought
    window.hasAutoReveal = false; 
    let rentPaidThisNight = false; // New flag

    function updateUI() {
        document.getElementById('coin-count').innerText = Math.floor(coins);
        document.getElementById('day-num').innerText = day;
        document.getElementById('ante-num').innerText = ante;
        document.getElementById('cards-count').innerText = `${cardsPlayed}`;
        document.getElementById('rent-amount').innerText = 5 + (day * 5 * ante);

        //const cardText = document.getElementById('cards-count');
        //if (cardText) cardText.innerText = `${cardsPlayed}/5`;

        // Populate symbol value in UI above Token Bar
        const levelBar = document.getElementById('symbol-levels');
        if (levelBar) {
            levelBar.innerHTML = Object.entries(symbolData)
                .map(([sym, data]) => `<span>${sym} <b style="color:var(--accent-blue)">Lvl ${data.lvl}</b></span>`)
                .join(' | ');
        }

        // --- GATE TICKET TABS ---
    const tabs = document.querySelectorAll('.ticket-tab');
    tabs.forEach(tab => {
        // We can check the text or a data attribute. 
        // Based on your HTML: MINI, MEGA, ULTRA
        const label = tab.innerText.toUpperCase();
        
        if (label.includes('MEGA') && day < 3) {
            tab.style.opacity = "0.4";
            tab.style.pointerEvents = "none";
            tab.title = "Unlocks on Day 3";
        } else if (label.includes('ULTRA') && day < 6) {
            tab.style.opacity = "0.4";
            tab.style.pointerEvents = "none";
            tab.title = "Unlocks on Day 6";
        } else {
            tab.style.opacity = "1";
            tab.style.pointerEvents = "auto";
            tab.title = "";
        }
    });

        const autoBtn = document.getElementById('auto-reveal-btn');
        if (window.hasAutoReveal) {
            // Show the button if they own the upgrade
            autoBtn.style.display = 'block'; 
        
            // Disable it if no card is currently being played
            autoBtn.disabled = !cardActive; 
        } else {
            autoBtn.style.display = 'none';
        }

        const bar = document.getElementById('token-bar');
if (bar) {
    bar.innerHTML = ''; // Clear the bar to rebuild
    for (let i = 0; i < 5; i++) {
        const slot = document.createElement('div');
        slot.className = 'token-slot';
        
        // 1. Check for Boss Frozen Slot
        const isFrozen = (day === 5 && i === frozenSlotIndex);
        
        if (isFrozen) {
            slot.style.background = "rgba(239, 68, 68, 0.2)";
            slot.style.borderColor = "#ef4444";
            slot.style.boxShadow = "inset 0 0 10px #ef4444";
        }

        // 2. Add Token Icon or Placeholder
        if (tokens[i]) {
            // Add the icon and ensure it doesn't block mouse events
            slot.innerHTML = `<span style="pointer-events: none;">${tokens[i].icon}</span>`;
            if (!isFrozen) slot.style.borderColor = 'var(--joker-purple)';
            
            // RESTORE HOVER INFO: Set the data-tip for the tooltip
            const prefix = isFrozen ? "[FROZEN] " : "";
            slot.setAttribute('data-tip', `${prefix}${tokens[i].name}: ${tokens[i].desc}`);
        } else {
            // Empty slot logic
            slot.innerHTML = isFrozen ? '<span style="pointer-events: none;">üö´</span>' : '<span style="opacity:0.2">+</span>';
            if (isFrozen) slot.setAttribute('data-tip', "This slot is currently disabled by the Tax Man!");
        }

        bar.appendChild(slot);
    }
}
    saveGame(); // Keep progress in sync
}

    function selectTicket(type, el) {
        if (cardActive) return;
        currentType = type;
        document.querySelectorAll('.ticket-tab').forEach(t => t.classList.remove('active'));
        el.classList.add('active');
        const t = TICKET_TYPES[type];
        const grid = document.getElementById('prize-grid');
        grid.style.gridTemplateColumns = `repeat(${t.cols}, 1fr)`;
        grid.innerHTML = '';
        for(let i=0; i < t.cols*t.rows; i++) {
            const c = document.createElement('div'); c.className = 'prize-cell'; c.innerText = '?'; grid.appendChild(c);
        }
    }

    let hasAutoScratch = false; // Set to true when bought in shop

function autoReveal() {
    if (!cardActive) return;
    cardActive = false;
    
    // Keep canvas visible to show effects
        // Visual Reveal Sequence
        canvas.style.transition = "opacity 0.8s ease-in";
        canvas.style.opacity = 1;

        // DRAW THE EFFECTS HERE
        if (winningIndices.length > 0) {
            drawWinEffects(winningIndices, winColor, isJackpot);
        } else {
            ctx.clearRect(0, 0, 320, 320); // Clear if no win
        }

        setTimeout(() => {
            // REMOVE: coins += pendingWin;  <-- Delete this line
            document.getElementById('result-modal').style.display = 'block';
        }, 2000);
}

    function buyCard() {
    const t = TICKET_TYPES[currentType];
    
    // BOSS
    let actualCost = t.cost;
    // Check if Inflation is active
    if (activeBossMod && activeBossMod.id === 'double_cost') {
        actualCost *= 2;
    }

    if (coins < t.cost) return alert("Broke!");

    // Draw scratch layer
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = '#cbd5e1'; 
    ctx.fillRect(0, 0, 320, 320);
    
    // Deduct cost immediately
    coins -= t.cost;
    
    currentSymbols = []; // Clear old
    const res = [];
    document.querySelectorAll('.prize-cell').forEach(c => {
        const s = symbols[Math.floor(Math.random()*symbols.length)];
        c.innerHTML = s; res.push(s);
    });

    // Score Calculation Breakdown
    currentSymbols = res; // Store for saving
    
    const counts = {}; res.forEach(s => counts[s] = (counts[s]||0)+1);
    const valCounts = Object.values(counts);
    const maxMatch = Math.max(...valCounts);
    const winningSymbol = Object.keys(counts).find(key => counts[key] === maxMatch);

    calculateWin(res); // Move math to a helper function

    cardActive = true;
    saveGame();
    updateUI();




    cardActive = true; 
    canvas.style.opacity = 1; 
    document.getElementById('buy-btn').disabled = true;

    // Show Auto-Reveal if upgrade is owned
if (window.hasAutoReveal) {
    document.getElementById('auto-reveal-btn').style.display = 'block';
}
    saveGame(); // <--- Add this here!
    updateUI();
}

function calculateWin(res) {
    const t = TICKET_TYPES[currentType];
    let base = 0;
    let matchType = "No Match";
    let winningSymbol = res[0]; 
    
    isJackpot = false;
    winningIndices = [];
    winColor = "var(--accent-green)";

    const gridWidth = t.cols;
    const lines = [];

    // --- 1. GENERATE LINES (Rows, Cols, Diagonals) ---
    for (let r = 0; r < t.rows; r++) {
        let row = []; for (let c = 0; c < t.cols; c++) row.push(r * gridWidth + c);
        lines.push(row);
    }
    for (let c = 0; c < t.cols; c++) {
        let col = []; for (let r = 0; r < t.rows; r++) col.push(r * gridWidth + c);
        lines.push(col);
    }
    // Always calculate diagonals
    let d1 = [], d2 = [];
    for (let i = 0; i < t.cols; i++) {
        d1.push(i * gridWidth + i);
        d2.push(i * gridWidth + (gridWidth - 1 - i));
    }
    lines.push(d1, d2);

    // --- 2. PATTERN CHECKING ---
    let bestPatternMatch = 0;

    // Check Jackpot & Match 3 (Pattern logic)
    for (let line of lines) {
        const symbolsInLine = line.map(idx => res[idx]);
        const firstS = symbolsInLine[0];
        
        if (symbolsInLine.every(s => s === firstS)) {
            let req = (currentType === 'mini') ? 4 : (currentType === 'mega' ? 3 : 4);
            if (symbolsInLine.length === req || (currentType === 'mini' && res.every(s => s === res[0]))) {
                isJackpot = true;
                winningIndices = (currentType === 'mini') ? [0,1,2,3] : line;
                winningSymbol = firstS;
                // NEW: Base win + (Symbol Value * 5 for Jackpot)
                base = t.win3 + (symbolData[winningSymbol].val * 5);
                matchType = "JACKPOT!";
                winColor = "var(--text-gold)";
                break;
            }
        }
    }

    // --- 3. L-SHAPE LOGIC (Now includes MINI) ---
    if (!isJackpot && bestPatternMatch < 3) {
        // We scan every 2x2 area of the grid for a "corner"
        for (let r = 0; r < t.rows - 1; r++) {
            for (let c = 0; c < t.cols - 1; c++) {
                const i = r * gridWidth + c;
                const right = i + 1;
                const down = i + gridWidth;
                const corner = i + gridWidth + 1;

                // Check 4 possible rotations of the L-shape corner
                const shapes = [
                    [i, right, down],   // ‚îå
                    [i, right, corner], // ‚îê
                    [i, down, corner],  // ‚îî
                    [right, down, corner] // ‚îò
                ];
                // L-SHAPE LOOP
                for (let shape of shapes) {
    if (res[shape[0]] === res[shape[1]] && res[shape[0]] === res[shape[2]]) {
    bestPatternMatch = 3;
    winningIndices = shape;
    winningSymbol = res[shape[0]];
    base = t.win3 || 10; // Use the ticket's win3 value
    matchType = "L-SHAPE!";
    break;
}
}
                if (bestPatternMatch === 3) break;
            }
            if (bestPatternMatch === 3) break;
        }
    }

    // --- 4. PAIR LOGIC ---
    if (!isJackpot && bestPatternMatch < 3) {
        if (activeBossMod?.id === 'no_pairs') {
            matchType = "Standardization (No Pairs)";
        } else {
            for (let line of lines) {
                const lineSyms = line.map(idx => res[idx]);
                if (lineSyms[0] === lineSyms[1]) {
                    winningSymbol = lineSyms[0];
                    winningIndices = [line[0], line[1]];
                    base = t.win2;
                    matchType = `Pair of ${winningSymbol}`;
                    bestPatternMatch = 2;
                    break;
                }
            }
        }
    }

    // Use the new symbolData structure
    let symBonus = symbolData[winningSymbol] ? symbolData[winningSymbol].val : 0;
    let symLvl = symbolData[winningSymbol] ? symbolData[winningSymbol].lvl : 1;

    // Multiplier calculation
    let mult = multipliers[winningSymbol] || 1;
    // finalWin calculation: base already includes the symbol value from the steps above
    let finalWin = Math.floor((base + symBonus) * mult);

    // Track bonuses for the breakdown display
    let flatBonus = 0;
    let diceTriggered = false;

    // 1. Apply Golden Coin (+5 flat win)
    if (tokens.some(t => t.id === 't1')) {
        flatBonus += 5;
    }

    // 2. Apply Lucky Dice (1 in 4 chance to double)
    if (tokens.some(t => t.id === 't2')) {
        if (Math.random() < 0.25) {
            diceTriggered = true;
        }
    }


// Calculate final total
   // FINAL CALCULATIONS
    if (diceTriggered) finalWin *= 2;
    
    // Apply Token Bonuses (Example: Golden Coin)
    if (tokens.some(tk => tk.id === 't1')) flatBonus += 5;

    pendingWin = finalWin + flatBonus;

    // UPDATE MODAL BREAKDOWN
    // We explicitly use .val and .lvl to avoid [object Object] errors
    document.getElementById('modal-title').innerText = pendingWin > 0 ? "WINNER!" : "TRY AGAIN";
    document.getElementById('modal-msg').innerHTML = `
    <div style="text-align: left; font-size: 0.85rem; color: #334155;">
        <div style="display:flex; justify-content:space-between;"><span>Result:</span> <b>${matchType}</b></div>
        <div style="display:flex; justify-content:space-between;"><span>Ticket Base:</span> <b>+${base}üí∞</b></div>
        <div style="display:flex; justify-content:space-between;"><span>${winningSymbol} Bonus (Lvl ${symLvl}):</span> <b style="color:var(--accent-blue)">+${symBonus}üí∞</b></div>
        <div style="display:flex; justify-content:space-between;"><span>Multiplier:</span> <b>x${mult.toFixed(1)}</b></div>
        ${flatBonus > 0 ? `<div style="display:flex; justify-content:space-between;"><span>Token Bonus:</span> <b>+${flatBonus}üí∞</b></div>` : ''}
        <hr style="border: 0.5px solid #e2e8f0; margin: 8px 0;">
        <div style="display:flex; justify-content:space-between; font-size: 1.1rem;"><b>Total:</b> <b style="color:var(--accent-green)">${pendingWin}üí∞</b></div>
    </div>
`;
    tokens.forEach((tk, index) => {
    // Only apply the token if it's NOT in the frozen slot
    if (index !== frozenSlotIndex) {
        if (tk.onWin) multiplier = tk.onWin(multiplier);
        // Add your other token logic here (Golden Coin, Dice, etc.)
        if (tk.id === 't1') finalWin += 5; 
    }
});
}

    function checkReveal() {
    const data = ctx.getImageData(0,0,320,320).data;
    let trans = 0; for(let i=3; i<data.length; i+=4) if(data[i] === 0) trans++;

    // Check if player scratched enough (roughly 55%)
    if (trans / (320*320) > (0.55 - strLvl*0.01)) {
        cardActive = false; 
        // Keep canvas visible to show effects
        // Visual Reveal Sequence
        canvas.style.transition = "none"; 
        canvas.style.opacity = 1;

        // DRAW THE EFFECTS HERE
        if (winningIndices.length > 0) {
            drawWinEffects(winningIndices, winColor, isJackpot);
        } else {
            ctx.clearRect(0, 0, 320, 320); // Clear if no win
        }

        setTimeout(() => {
            // REMOVE: coins += pendingWin;  <-- Delete this line
            document.getElementById('result-modal').style.display = 'block';
        }, 2000);
    }
}

function drawWinEffects(indices, color, isJackpot) {
    const cells = document.querySelectorAll('.prize-cell');
    ctx.clearRect(0, 0, 320, 320); // Clear scratch layer
    ctx.globalCompositeOperation = 'source-over';
    
    // Highlight winning symbols
    indices.forEach(idx => {
        const cell = cells[idx];
        const rect = {
            x: cell.offsetLeft,
            y: cell.offsetTop,
            w: cell.offsetWidth,
            h: cell.offsetHeight
        };

        // Draw Glow Box
        ctx.shadowBlur = 20;
        ctx.shadowColor = color === "var(--text-gold)" ? "#f1c40f" : 
                         (color === "var(--joker-purple)" ? "#a855f7" : "#22c55e");
        ctx.strokeStyle = ctx.shadowColor;
        ctx.lineWidth = 4;
        ctx.strokeRect(rect.x + 5, rect.y + 5, rect.w - 10, rect.h - 10);
    });

    // Draw Jackpot Strike Line
    if (isJackpot && indices.length > 0) {
        const first = cells[indices[0]];
        const last = cells[indices[indices.length - 1]];
        
        ctx.beginPath();
        ctx.moveTo(first.offsetLeft + first.offsetWidth/2, first.offsetTop + first.offsetHeight/2);
        ctx.lineTo(last.offsetLeft + last.offsetWidth/2, last.offsetTop + last.offsetHeight/2);
        ctx.lineWidth = 10;
        ctx.lineCap = 'round';
        ctx.stroke();
    }
    ctx.shadowBlur = 0; // Reset shadow
}

function resumeActiveCard() {
    // 1. Set the correct ticket tab UI
    const tabs = document.querySelectorAll('.ticket-tab');
    tabs.forEach(t => {
        if (t.innerText.toLowerCase().includes(currentType)) t.classList.add('active');
        else t.classList.remove('active');
    });

    // 2. Rebuild the Grid
    const t = TICKET_TYPES[currentType];
    const grid = document.getElementById('prize-grid');
    grid.style.gridTemplateColumns = `repeat(${t.cols}, 1fr)`;
    grid.innerHTML = '';
    
    currentSymbols.forEach(s => {
        const c = document.createElement('div'); 
        c.className = 'prize-cell'; 
        c.innerHTML = s; 
        grid.appendChild(c);
    });

    // 3. Prepare Canvas
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = '#cbd5e1'; 
    ctx.fillRect(0, 0, 320, 320);
    
    // 4. Lock UI
    document.getElementById('buy-btn').disabled = true;
    if (window.hasAutoReveal) document.getElementById('auto-reveal-btn').style.display = 'block';

    // 5. Re-run the win math so winningIndices are ready
    calculateWin(currentSymbols); 
}

    // THIS IS WHERE THE MONEY IS ACTUALLY GIVEN
function closeModal() {
    coins += pendingWin; // Give the player the reward now
    pendingWin = 0;      // Reset it so they can't collect twice

    cardsPlayed++;

    
    document.getElementById('result-modal').style.display = 'none';
    document.getElementById('buy-btn').disabled = false;
    
    // Clear the board for the next card
    document.querySelectorAll('.prize-cell').forEach(c => c.innerText = "?");
    ctx.clearRect(0,0,320,320);

    cardActive = false;
    currentSymbols = []; // Wipe the saved card
    saveGame();
    updateUI(); // Refresh the counter
    
    // Logic to open shop or refresh UI
    if (cardsPlayed >= 5) openShop();
    else updateUI();
}

function openShop() {
    const rerollDisp = document.getElementById('reroll-display');
    if (rerollDisp) rerollDisp.innerText = rerollCost;

    let rerollCost = 5;

    const rent = 5 + (day * 5 * ante);

    // Apply Tax Loophole if owned
    const effectiveRent = tokens.some(t => t.id === 't4') ? Math.max(0, rent - 10) : rent;
    
    // Only deduct rent once per night
    if (!rentPaidThisNight) {
        if (coins < effectiveRent) {
            alert("GAME OVER: CAN'T PAY RENT!");
            resetRun(); 
            return;
        }
        coins -= effectiveRent;
        rentPaidThisNight = true; 
        saveGame();
    }

    document.getElementById('shop-rent-msg').innerHTML = `Paid <b>${effectiveRent}üí∞</b> Rent. Balance: <b>${Math.floor(coins)}üí∞</b>`;
    
   renderShopItems();

    document.getElementById('shop-modal').style.display = 'block';
    updateUI();
}

    function addShopItem(gridId, name, desc, cost, uniqueId, action) {
    const grid = document.getElementById(gridId);
    const div = document.createElement('div');
    const isSold = boughtItemsThisNight.has(uniqueId);
    
    div.className = `item-card ${isSold ? 'sold-out' : ''}`;
    div.innerHTML = `
        <div class="item-info"><b>${name}</b><span>${desc}</span></div>
        <button class="btn-buy-item" ${coins < cost || isSold ? 'disabled' : ''}>${isSold ? 'SOLD' : cost + 'üí∞'}</button>
    `;

    div.querySelector('button').onclick = () => {
        if (coins >= cost) {
            coins -= cost;
            action();
            boughtItemsThisNight.add(uniqueId);
            saveGame();
            updateUI();
            openShop(); // Re-render to update all buttons
        }
    };
    grid.appendChild(div);
}

function nextDay() {
    rentPaidThisNight = false; // Reset for the next night
    boughtItemsThisNight.clear(); // Refresh stock for next night
    day++;
    cardsPlayed = 0;

    if (day === 5) {
    activeBossMod = BOSS_MODS[Math.floor(Math.random() * BOSS_MODS.length)];
    
    // If Audit is chosen, pick a random slot 0-4
    if (activeBossMod.id === 'frozen_slot') {
        frozenSlotIndex = Math.floor(Math.random() * 5);
    } else {
        frozenSlotIndex = null;
    }

    document.getElementById('mod-name').innerText = activeBossMod.name;
    document.getElementById('mod-desc').innerText = (activeBossMod.id === 'frozen_slot') 
        ? `Slot #${frozenSlotIndex + 1} is being audited. Tokens there are disabled!` 
        : activeBossMod.desc;
    
    document.getElementById('boss-modal').style.display = 'block';
}

    saveGame();
    document.getElementById('shop-modal').style.display = 'none';
    document.getElementById('buy-btn').disabled = false;
    updateUI();
}

function closeBossModal() {
    document.getElementById('boss-modal').style.display = 'none';
}

function rerollShop() {
    if (coins < rerollCost) {
        alert("Not enough coins to reroll!");
        return;
    }

    coins -= rerollCost;
    rerollCost += 2; // Increase cost per reroll to prevent infinite fishing
    
    // Refresh the shop items
    renderShopItems();
    
    // Update the UI to show new coin balance and new reroll price
    updateUI();
    saveGame();
}

function renderShopItems() {
    // Clear existing items so they don't stack up when rerolling
    document.getElementById('gear-grid').innerHTML = '';
    document.getElementById('token-grid').innerHTML = '';
    document.getElementById('voucher-grid').innerHTML = '';

     const container = document.getElementById('shop-items');
    container.innerHTML = `
        <div class="shop-section">
            <div class="shop-section-title">GEAR & VIP</div>
            <div id="gear-grid" class="shop-grid"></div>
        </div>
        <div class="shop-section">
            <div class="shop-section-title">LUCKY TOKENS</div>
            <div id="token-grid" class="shop-grid"></div>
        </div>
        <div class="shop-section">
            <div class="shop-section-title">VOUCHERS</div>
            <div id="voucher-grid" class="shop-grid"></div>
        </div>
    `;

    // 1. GEAR (Permanent Stats)
    // Items check against boughtItemsThisNight
    addShopItem("gear-grid", "Widen Coin", `Lvl ${sizeLvl+1}`, sizeLvl*40, "widen", () => sizeLvl++);
    addShopItem("gear-grid", "Scratch Power", `Lvl ${strLvl+1}`, strLvl*60, "power", () => strLvl++);

    const dailyTokens = TOKENS_DB.filter(t => !tokens.some(mt => mt.id === t.id)).slice(0, 2);
    dailyTokens.forEach(t => {
        addShopItem("token-grid", `${t.icon} ${t.name}`, t.desc, t.cost, t.id, () => tokens.push(t));
    });

    if (!window.hasAutoReveal) {
        addShopItem("voucher-grid", "‚ö° Auto-Laser", "Unlocks Quick Reveal", 1000, "autolaser", () => window.hasAutoReveal = true);
    }

    // 4. SYMBOL UPGRADES (Celestial Style)
    // Pick 2 random symbols for the shop
    // --- CELESTIAL SYMBOL UPGRADES ---
    // This part runs every time rerollShop() calls renderShopItems()
    const available = Object.keys(symbolData).sort(() => 0.5 - Math.random()).slice(0, 2);
    available.forEach(sym => {
        addShopItem("voucher-grid", `${sym} Level Up`, `+5üí∞ base value for ${sym}`, 40, `lvl_${sym}`, () => {
            symbolData[sym].val += 5;
            symbolData[sym].lvl += 1;
            updateUI(); // Ensure the Level Bar updates immediately
        });
    });
    // Update the reroll button text
    document.getElementById('reroll-display').innerText = rerollCost;
}

    // --- SYSTEMS ---
    function scratch(e) {
        if (!isDrawing || !cardActive) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
        ctx.globalCompositeOperation = 'destination-out';
        ctx.lineWidth = 12 + sizeLvl*2; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x,y); ctx.stroke();
        lastX = x; lastY = y;
        if (Math.random()>0.9) checkReveal();
    }
    canvas.addEventListener('mousedown', e => { isDrawing=true; lastX=e.offsetX; lastY=e.offsetY; });
    window.addEventListener('mouseup', () => isDrawing=false);
    canvas.addEventListener('mousemove', scratch);
    canvas.addEventListener('touchstart', e => { isDrawing=true; const r=canvas.getBoundingClientRect(); lastX=e.touches[0].clientX-r.left; lastY=e.touches[0].clientY-r.top; }, {passive:false});
    canvas.addEventListener('touchmove', scratch, {passive:false});
    function animate() { requestAnimationFrame(animate); }

    // --- SAVE SYSTEM ---
function saveGame() {
    // We must include EVERY variable we want to survive a refresh
    const gameState = { 
        coins, 
        sizeLvl, 
        strLvl, 
        day, 
        ante, 
        tokens, 
        hasAutoReveal: window.hasAutoReveal, // Use the window prefix to be safe
        cardsPlayed, 
        rentPaidThisNight,
        rerollCost, // Added this so rerolls don't reset to 5üí∞ on refresh
        cardActive,
        currentSymbols,
        currentType,
        symbolData
    };
    localStorage.setItem('scratch_inc_save', JSON.stringify(gameState));
    console.log("Game Saved:", gameState); // Helpful for debugging
}

function loadGame() {
    const saved = localStorage.getItem('scratch_inc_save');
    if (saved) {
        const data = JSON.parse(saved);
        coins = data.coins || 20; 
        sizeLvl = data.sizeLvl || 1; 
        strLvl = data.strLvl || 1;
        day = data.day || 1; 
        ante = data.ante || 1; 
        tokens = data.tokens || [];
        window.hasAutoReveal = data.hasAutoReveal || false;
        cardsPlayed = data.cardsPlayed || 0;
        rentPaidThisNight = data.rentPaidThisNight || false;
        rerollCost = data.rerollCost || 5;
        // Restore card state
        cardActive = data.cardActive || false;
        currentSymbols = data.currentSymbols || [];
        currentType = data.currentType || 'mini';
        // RESTORE SYMBOL DATA
        if (data.symbolData) {
            symbolData = data.symbolData;
        }
        if (cardActive && currentSymbols.length > 0) {
            resumeActiveCard();
        }
    }
}

function resetRun() {
    if (confirm("Reset your entire run? All coins and upgrades will be lost.")) {
        localStorage.removeItem('scratch_inc_save');
        location.reload();
    }
}

// INIT
    selectTicket('mini', document.querySelector('.ticket-tab'));
    loadGame(); 
    updateUI();
    animate();

</script>
</body>
</html>