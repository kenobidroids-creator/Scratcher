<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scratch Upgrader</title>
    <style>
        body { 
            font-family: 'Courier New', Courier, monospace; 
            background: #1a1a1a; color: #fff; margin: 0; display: flex; flex-direction: column; align-items: center; 
            touch-action: none;
        }
        .game-layout { display: flex; gap: 20px; padding: 20px; flex-wrap: wrap; justify-content: center; }
        
        /* Stats & Card */
        .main-area { display: flex; flex-direction: column; align-items: center; }
        .stats { font-size: 2rem; color: #f1c40f; margin-bottom: 10px; text-shadow: 2px 2px #000; }
        
        .card-container {
            position: relative; width: 300px; height: 300px;
            background: #fff; border-radius: 10px; overflow: hidden; border: 4px solid #444;
        }
        .prize-grid {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
            width: 100%; height: 100%; position: absolute;
        }
        .prize-cell {
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; border: 1px solid #ddd; color: #222;
        }
        canvas { position: absolute; top: 0; left: 0; cursor: crosshair; z-index: 10; }

        /* Shop Sidebar */
        .shop {
            background: #333; padding: 20px; border-radius: 10px; width: 200px;
            border: 2px solid #555;
        }
        .shop h3 { margin-top: 0; color: #27ae60; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .upgrade-item { margin-bottom: 15px; }
        .upgrade-item p { margin: 5px 0; font-size: 0.9rem; }
        
        /* Buttons */
        button { 
            background: #27ae60; color: white; border: none; padding: 10px; 
            width: 100%; border-radius: 5px; cursor: pointer; font-weight: bold;
        }
        button:disabled { background: #555; cursor: not-allowed; }
        button:active { transform: scale(0.98); }
        #buy-btn { font-size: 1.2rem; padding: 15px; margin-top: 10px; width: 300px; }

        /* Particle layer */
        #particle-canvas { pointer-events: none; position: absolute; z-index: 20; }

        .modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #fff; color: #333; padding: 20px; border-radius: 10px; z-index: 100;
            text-align: center; border: 5px solid #f1c40f;
        }
    </style>
</head>
<body>

    <div class="stats">üí∞ <span id="coin-count">10</span></div>

    <div class="game-layout">
        <div class="main-area">
            <div class="card-container">
                <div class="prize-grid">
                    <div class="prize-cell">?</div><div class="prize-cell">?</div>
                    <div class="prize-cell">?</div><div class="prize-cell">?</div>
                </div>
                <canvas id="scratch-canvas" width="300" height="300"></canvas>
                <canvas id="particle-canvas" width="300" height="300"></canvas>
            </div>
            <button id="buy-btn" onclick="buyCard()">BUY CARD (2 üí∞)</button>
        </div>

        <div class="shop">
            <h3>UPGRADES</h3>
            <div class="upgrade-item">
                <p>Size: <span id="size-lvl">1</span></p>
                <button id="up-size" onclick="upgrade('size')">Widen (50 üí∞)</button>
            </div>
            <div class="upgrade-item">
                <p>Strength: <span id="str-lvl">1</span></p>
                <button id="up-str" onclick="upgrade('strength')">Power (75 üí∞)</button>
            </div>
        </div>
    </div>

    <div id="result-modal" class="modal">
        <h2 id="modal-title"></h2>
        <p id="modal-msg"></p>
        <button onclick="closeModal()">COLLECT</button>
    </div>

<script>
    // --- State ---
    let coins = parseInt(localStorage.getItem('scratcher_coins')) || 10;
    let sizeLvl = parseInt(localStorage.getItem('size_lvl')) || 1;
    let strLvl = parseInt(localStorage.getItem('str_lvl')) || 1;
    
    const symbols = ['üçí', 'üíé', 'üçã', '‚≠ê', 'üîî'];
    const canvas = document.getElementById('scratch-canvas');
    const ctx = canvas.getContext('2d');
    const pCanvas = document.getElementById('particle-canvas');
    const pCtx = pCanvas.getContext('2d');
    
    let isDrawing = false;
    let cardActive = false;
    let pendingWin = 0;
    let particles = [];

    // --- Init ---
    updateUI();
    handleRecharge();
    animateParticles();

    function updateUI() {
        document.getElementById('coin-count').innerText = coins;
        document.getElementById('size-lvl').innerText = sizeLvl;
        document.getElementById('str-lvl').innerText = strLvl;
        
        document.getElementById('up-size').innerText = `Widen (${sizeLvl * 50} üí∞)`;
        document.getElementById('up-str').innerText = `Power (${strLvl * 75} üí∞)`;
        
        document.getElementById('up-size').disabled = coins < (sizeLvl * 50);
        document.getElementById('up-str').disabled = coins < (strLvl * 75);

        localStorage.setItem('scratcher_coins', coins);
        localStorage.setItem('size_lvl', sizeLvl);
        localStorage.setItem('str_lvl', strLvl);
    }

    // --- Upgrades ---
    function upgrade(type) {
        if (type === 'size') {
            const cost = sizeLvl * 50;
            if (coins >= cost) { coins -= cost; sizeLvl++; }
        } else {
            const cost = strLvl * 75;
            if (coins >= cost) { coins -= cost; strLvl++; }
        }
        updateUI();
    }

    // --- Time Rewards (4 every 4hrs) ---
    function handleRecharge() {
        const now = Date.now();
        const last = parseInt(localStorage.getItem('last_login_time')) || now;
        const hours = (now - last) / (1000 * 60 * 60);
        let blocks = Math.floor(hours / 4);
        if (blocks > 0) {
            const bonus = Math.min(blocks * 4, 12);
            coins += bonus;
            alert(`Earned ${bonus} coins while away!`);
            localStorage.setItem('last_login_time', now.toString());
            updateUI();
        }
    }

    // --- Particle System ---
    function createParticles(x, y) {
        for(let i=0; i<3 * strLvl; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 4,
                vy: (Math.random() - 0.5) * 4,
                life: 20 + Math.random() * 20,
                size: 2 + Math.random() * 3
            });
        }
    }

    function animateParticles() {
        pCtx.clearRect(0, 0, 300, 300);
        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life--;
            pCtx.fillStyle = `rgba(150, 150, 150, ${p.life/40})`;
            pCtx.fillRect(p.x, p.y, p.size, p.size);
            if(p.life <= 0) particles.splice(i, 1);
        });
        requestAnimationFrame(animateParticles);
    }

    // --- Game Logic ---
    function buyCard() {
        if (coins < 2) return alert("Not enough coins!");
        coins -= 2;
        updateUI();
        
        canvas.style.transition = "none";
        canvas.style.opacity = "1";
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = '#C0C0C0';
        ctx.fillRect(0, 0, 300, 300);
        
        // Symbols
        const res = [];
        document.querySelectorAll('.prize-cell').forEach(c => {
            const s = symbols[Math.floor(Math.random() * symbols.length)];
            c.innerText = s; res.push(s);
        });

        const counts = {};
        res.forEach(s => counts[s] = (counts[s] || 0) + 1);
        const maxMatch = Math.max(...Object.values(counts));
        pendingWin = maxMatch >= 3 ? 20 : (maxMatch === 2 ? 5 : 0);
        
        document.getElementById('modal-title').innerText = pendingWin > 0 ? "Winner!" : "No Luck";
        document.getElementById('modal-msg').innerText = `Found ${maxMatch} matches.`;
        
        cardActive = true;
        document.getElementById('buy-btn').disabled = true;
    }

    function scratch(e) {
        if (!isDrawing || !cardActive) return;
        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

        ctx.globalCompositeOperation = 'destination-out';
        
        // The "Scratch" brush influenced by upgrades
        const radius = 15 + (sizeLvl * 5);
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2);
        ctx.fill();

        createParticles(x, y);

        // Strength makes completion happen with less effort
        if (Math.random() > 0.9) checkReveal();
    }

    function checkReveal() {
        const data = ctx.getImageData(0,0,300,300).data;
        let trans = 0;
        for(let i=3; i<data.length; i+=4) if(data[i] === 0) trans++;
        
        // Higher strength = card finishes earlier (Threshold drops)
        const threshold = 0.5 - (strLvl * 0.02); 
        if ((trans / (300*300)) > Math.max(threshold, 0.2)) {
            cardActive = false;
            canvas.style.transition = "opacity 1s";
            canvas.style.opacity = "0";
            setTimeout(() => {
                coins += pendingWin;
                updateUI();
                document.getElementById('result-modal').style.display = 'block';
            }, 1000);
        }
    }

    function closeModal() {
        document.getElementById('result-modal').style.display = 'none';
        document.getElementById('buy-btn').disabled = false;
        ctx.clearRect(0,0,300,300);
        localStorage.setItem('last_login_time', Date.now().toString());
    }

    canvas.addEventListener('mousedown', () => isDrawing = true);
    window.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mousemove', scratch);
    canvas.addEventListener('touchstart', (e) => { isDrawing = true; scratch(e); }, {passive:false});
    canvas.addEventListener('touchend', () => isDrawing = false);
    canvas.addEventListener('touchmove', scratch, {passive:false});
</script>
</body>
</html>
